[1m============================= test session starts =============================[0m
platform win32 -- Python 3.12.9, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\PC\AppData\Local\Programs\Python\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\projects\nexus-trading
configfile: pytest.ini
testpaths: tests
plugins: anyio-4.10.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
[1mcollecting ... [0mcollected 129 items / 1 error

<Package nexus-trading>
  <Dir tests>
    <Dir agents>
      <Dir llm>
        <Module test_claude_agent.py>
          Tests para ClaudeAgent.
          <Coroutine test_decide_success>
          <Coroutine test_decide_skip_volatile>
        <Module test_context_builder.py>
          Tests para ContextBuilder.
          <Coroutine test_build_context_success>
          <Coroutine test_build_context_partial_failure>
          <Coroutine test_caching>
        <Module test_factory.py>
          Tests para LLMAgentFactory.
          <Function test_create_claude_agent>
          <Function test_create_from_config_object>
          <Function test_missing_api_key>
          <Function test_unknown_provider>
        <Module test_interfaces.py>
          Tests para interfaces del LLM Agent.
          <Class TestAutonomyLevel>
            <Function test_enum_values>
          <Class TestPortfolioPosition>
            <Function test_market_value>
            <Function test_immutability>
          <Class TestRiskLimits>
            <Function test_can_trade_true>
            <Function test_can_trade_false_max_trades>
            <Function test_can_trade_false_max_loss>
          <Class TestAgentContext>
            <Function test_to_dict_serializable>
          <Class TestAgentDecision>
            <Function test_confidence_validation>
            <Function test_has_actions>
        <Module test_prompts.py>
          Tests para generación de prompts.
          <Function test_conservative_prompt_content>
            Verify conservative prompt content.
          <Function test_moderate_prompt_content>
            Verify moderate prompt content.
    <Package strategies>
      <Module test_ai_agent_strategy.py>
        Tests para AIAgentStrategy.
        <Coroutine test_generate_signals_success>
        <Coroutine test_generate_signals_error>
      <Module test_etf_momentum.py>
        Tests para estrategia ETF Momentum.
        <Class TestMomentumCalculator>
          Tests para MomentumCalculator.
          <Function test_calculate_momentum_score>
            Calcular score correctamente.
          <Function test_rank_universe>
            Rankear universo correctamente.
          <Function test_insufficient_data_raises>
            Error si no hay suficientes datos.
        <Class TestETFMomentumStrategy>
          Tests para estrategia ETF Momentum.
          <Function test_strategy_properties>
            Verificar propiedades básicas.
          <Function test_can_operate_in_bull>
            Puede operar en régimen BULL.
          <Function test_cannot_operate_in_bear>
            No puede operar en régimen BEAR.
          <Coroutine test_generate_signals_in_bull>
            Generar señales en régimen BULL.
          <Coroutine test_no_signals_in_bear>
            No generar señales en régimen BEAR.
          <Coroutine test_respects_max_positions>
            Respetar límite de posiciones.
          <Coroutine test_should_close_on_regime_change>
            Cerrar posición si régimen cambia a BEAR.
          <Coroutine test_should_close_on_high_rsi>
            Cerrar posición si RSI está sobrecomprado.
      <Module test_interfaces.py>
        Tests para interfaces y dataclasses de estrategias.
        <Class TestSignal>
          Tests para Signal dataclass.
          <Function test_signal_creation_valid>
            Crear señal válida.
          <Function test_signal_requires_entry_for_long>
            Señales LONG requieren entry_price.
          <Function test_signal_requires_stop_loss>
            Señales LONG/SHORT requieren stop_loss.
          <Function test_confidence_validation>
            Confianza debe estar entre 0 y 1.
          <Function test_risk_reward_ratio>
            Calcular ratio riesgo/beneficio.
          <Function test_signal_expiration>
            Verificar expiración de señal.
          <Function test_signal_serialization>
            Serializar y deserializar señal.
    <Dir test_agents>
      <Module test_base_agent.py>
        Tests for BaseAgent class.
        
        CRITICAL: BaseAgent is the foundation for all agents.
        These tests validate lifecycle, health checks, and error handling.
        <Class TestBaseAgentInitialization>
          Test BaseAgent initialization.
          <Function test_initialization>
            Test agent initializes with correct attributes.
          <Function test_logger_name>
            Test logger is configured with agent name.
        <Class TestBaseAgentLifecycle>
          Test BaseAgent lifecycle management.
          <Coroutine test_start_calls_setup>
            Test that start() calls setup().
          <Coroutine test_start_starts_process_loop>
            Test that start() begins the process loop.
          <Coroutine test_stop_gracefully>
            Test that stop() gracefully stops the agent.
          <Coroutine test_cannot_start_twice>
            Test that starting an already-running agent does nothing.
          <Coroutine test_last_activity_updated>
            Test that _last_activity is updated during processing.
        <Class TestBaseAgentHealthCheck>
          Test BaseAgent health check functionality.
          <Function test_health_stopped>
            Test health check when agent is stopped.
          <Coroutine test_health_healthy>
            Test health check when agent is running normally.
          <Coroutine test_health_degraded_after_max_errors>
            Test health check shows degraded after max errors.
        <Class TestBaseAgentErrorHandling>
          Test BaseAgent error handling.
          <Coroutine test_process_exception_logged>
            Test that exceptions in process() are logged.
          <Coroutine test_max_errors_stops_agent>
            Test that agent stops after max consecutive errors.
          <Coroutine test_error_count_resets_on_success>
            Test that error count resets after successful iteration.
        <Class TestBaseAgentAbstractMethods>
          Test that abstract methods must be implemented.
          <Function test_cannot_instantiate_without_setup>
            Test that BaseAgent cannot be instantiated without setup().
          <Function test_cannot_instantiate_without_process>
            Test that BaseAgent cannot be instantiated without process().
        <Class TestBaseAgentRepr>
          Test BaseAgent string representation.
          <Function test_repr_stopped>
            Test repr when agent is stopped.
          <Coroutine test_repr_running>
            Test repr when agent is running.
      <Module test_messaging.py>
        Tests for Redis MessageBus.
        
        CRITICAL: These tests validate the core messaging infrastructure
        that all agents depend on for communication.
        <Class TestMessageBusBasics>
          Test basic MessageBus functionality.
          <Function test_initialization>
            Test MessageBus can be initialized.
          <Function test_subscribe>
            Test subscribing to a channel.
          <Function test_unsubscribe>
            Test unsubscribing from a channel.
          <Function test_health_check_healthy>
            Test health check when Redis is accessible.
        <Class TestMessageSerialization>
          Test message serialization and deserialization.
          <Function test_publish_trading_signal>
            Test publishing a TradingSignal.
          <Function test_publish_risk_request>
            Test publishing a RiskRequest.
        <Class TestMessagePubSub>
          Test end-to-end pub/sub functionality.
          <Coroutine test_publish_and_receive>
            Test publishing and receiving a message.
          <Coroutine test_multiple_subscribers>
            Test multiple subscribers on same channel.
          <Coroutine test_channel_isolation>
            Test that messages only go to subscribed channels.
        <Class TestChannelModels>
          Test CHANNEL_MODELS mapping.
          <Function test_channel_models_defined>
            Test that all expected channels have model mappings.
          <Function test_signals_channel_maps_to_trading_signal>
            Test signals channel maps to TradingSignal.
          <Function test_risk_requests_channel_maps_correctly>
            Test risk:requests channel maps to RiskRequest.
          <Function test_risk_responses_channel_maps_correctly>
            Test risk:responses channel maps to RiskResponse.
        <Class TestErrorHandling>
          Test error handling in MessageBus.
          <Function test_publish_with_invalid_redis>
            Test publishing when Redis fails.
          <Coroutine test_handler_exception_doesnt_crash_bus>
            Test that exception in handler doesn't crash the bus.
      <Module test_schemas.py>
        Tests for message schemas.
        <Class TestTradingSignal>
          Tests for TradingSignal model.
          <Function test_valid_signal>
            Test creating a valid trading signal.
          <Function test_confidence_validation>
            Test that confidence must be between 0 and 1.
          <Function test_negative_price_rejected>
            Test that negative prices are rejected.
          <Function test_default_ttl>
            Test that default TTL is 300 seconds.
        <Class TestRiskRequest>
          Tests for RiskRequest model.
          <Function test_valid_request>
            Test creating a valid risk request.
          <Function test_negative_capital_rejected>
            Test that negative capital is rejected.
        <Class TestRiskResponse>
          Tests for RiskResponse model.
          <Function test_approved_response>
            Test creating an approved risk response.
          <Function test_rejected_response>
            Test creating a rejected risk response.
        <Class TestDecision>
          Tests for Decision model.
          <Function test_execute_decision>
            Test creating an execute decision.
          <Function test_invalid_action_rejected>
            Test that invalid actions are rejected.
        <Class TestAlert>
          Tests for Alert model.
          <Function test_critical_alert>
            Test creating a critical alert.
          <Function test_invalid_severity_rejected>
            Test that invalid severity is rejected.
        <Class TestAgentStatus>
          Tests for AgentStatus model.
          <Function test_healthy_status>
            Test creating a healthy status.
          <Function test_invalid_status_rejected>
            Test that invalid status is rejected.
    <Module test_sanity.py>
      <Function test_ok>
    <Package tests_trading>
      <Module test_registry.py>
        Tests for Strategy Registry.
        
        Tests cover:
        - Loading strategies from PostgreSQL
        - State management in Redis
        - Regime filtering
        - Weight calculation
        - State transitions
        <Class TestStrategyRegistryInit>
          Test StrategyRegistry initialization.
          <Function test_initialization>
            Test registry initializes correctly.
        <Class TestLoadStrategies>
          Test loading strategies from database.
          <Function test_load_strategies_success>
            Test successful loading of strategies.
          <Function test_load_strategies_initializes_state>
            Test that Redis state is initialized for new strategies.
          <Function test_strategy_config_parsed_correctly>
            Test that StrategyConfig is parsed correctly from DB.
        <Class TestStateManagement>
          Test strategy state management.
          <Function test_get_state_from_redis>
            Test getting state from Redis.
          <Function test_get_state_initializes_if_not_exists>
            Test state initialization if not in Redis.
          <Function test_set_state_valid_transition>
            Test setting state with valid transition.
          <Function test_set_state_invalid_transition_raises>
            Test that invalid state transition raises error.
          <Function test_set_state_unknown_strategy_raises>
            Test setting state for unknown strategy raises error.
        <Class TestRegimeFiltering>
          Test filtering strategies by regime.
          <Function test_get_active_for_regime>
            Test getting active strategies for a regime.
          <Function test_get_active_for_regime_no_matches>
            Test regime with no active strategies.
          <Function test_filters_by_state_and_regime>
            Test filtering requires both active state AND compatible regime.
        <Class TestWeightCalculation>
          Test dynamic weight calculation.
          <Function test_calculate_weights_basic>
            Test basic weight calculation.
          <Function test_calculate_weights_applies_constraints>
            Test that min/max weight constraints are applied.
          <Function test_calculate_weights_no_performance_data>
            Test equal weights when no performance data.
          <Function test_calculate_weights_empty_list>
            Test with empty strategy list.
        <Class TestUtilityMethods>
          Test utility methods.
          <Function test_get_strategy>
            Test getting strategy by ID.
          <Function test_get_strategy_not_found>
            Test getting non-existent strategy.
          <Function test_list_all_strategies>
            Test listing all strategies.
          <Function test_get_strategy_count>
            Test getting strategy count.
    <Dir unit>
      <Dir data>
        <Module test_symbols.py>
          Unit tests for Symbol Registry module
          
          Tests the Symbol dataclass and SymbolRegistry functionality including
          loading from YAML, filtering by market/source, and validation.
          <Class TestSymbol>
            Test cases for Symbol dataclass.
            <Function test_symbol_creation>
              Test creating a valid symbol.
            <Function test_symbol_empty_ticker_raises>
              Test that empty ticker raises ValueError.
          <Class TestSymbolRegistry>
            Test cases for SymbolRegistry.
            <Function test_load_symbols>
              Test loading symbols from YAML config.
            <Function test_file_not_found>
              Test that missing config file raises FileNotFoundError.
            <Function test_get_by_market>
              Test filtering symbols by market.
            <Function test_get_by_source>
              Test filtering symbols by data source.
            <Function test_get_by_ticker>
              Test getting symbol by ticker.
            <Function test_get_by_asset_type>
              Test filtering symbols by asset type.
            <Function test_get_tickers>
              Test getting list of tickers.
            <Function test_invalid_yaml>
              Test handling of invalid YAML.
            <Function test_missing_symbols_key>
              Test config file without 'symbols' key.
            <Function test_repr>
              Test string representation of registry.
        <Module test_yahoo.py>
          Unit tests for Yahoo Finance data provider
          
          Tests historical download, incremental updates, rate limiting,
          error handling, and data validation.
          <Class TestYahooProvider>
            Test cases for YahooProvider.
            <Function test_initialization>
              Test provider initialization with custom parameters.
            <Function test_default_initialization>
              Test provider initialization with defaults.
            <Coroutine test_get_historical_success>
              Test successful historical data download.
            <Function test_standardize_dataframe>
              Test DataFrame standardization.
            <Function test_standardize_empty_dataframe>
              Test standardization of empty DataFrame.
            <Function test_rate_limiting>
              Test that rate limiting is enforced.
            <Coroutine test_get_current_price>
              Test getting current price.
            <Coroutine test_get_current_price_no_data>
              Test getting current price when no data available.
            <Coroutine test_retry_on_error>
              Test retry logic on errors.
            <Function test_repr>
              Test string representation.

=================================== ERRORS ====================================
[31m[1m__________________ ERROR collecting tests/ml/test_factory.py __________________[0m
[31mimport file mismatch:
imported module 'test_factory' has this __file__ attribute:
  C:\projects\nexus-trading\tests\agents\llm\test_factory.py
which is not the same as the test file we want to collect:
  C:\projects\nexus-trading\tests\ml\test_factory.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules[0m
[33m============================== warnings summary ===============================[0m
..\..\Users\PC\AppData\Local\Programs\Python\Python312\Lib\site-packages\eventkit\util.py:21
  C:\Users\PC\AppData\Local\Programs\Python\Python312\Lib\site-packages\eventkit\util.py:21: DeprecationWarning: There is no current event loop
    return asyncio.get_event_loop_policy().get_event_loop()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
[36m[1m=========================== short test summary info ===========================[0m
[31mERROR[0m tests/ml/test_factory.py
!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!
[31m==================== [32m129 tests collected[0m, [31m1 error[0m[31m in 3.10s[0m[31m ====================[0m
