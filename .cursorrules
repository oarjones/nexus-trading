# Project Rules & AI Assistant Guidelines

## 1. General Behavior
- **Language:** English ONLY for all code, comments, documentation, and commit messages.
- **Conciseness:** Be brief and direct. Avoid unnecessary conversational filler.
- **Proactivity:** Anticipate next steps but ask before major architectural changes.

## 2. Code Quality & Style
- **Standards:** Follow PEP 8 for Python.
- **Principles:** Apply SOLID, DRY (Don't Repeat Yourself), and KISS (Keep It Simple, Stupid) principles.
- **Clean Code:**
  - Meaningful variable and function names.
  - Small, focused functions (single responsibility).
  - Avoid magic numbers/strings; use constants.

## 3. Testing (CRITICAL)
    └── trading/
    
    tests/
    ├── test_agents/  ← Tests (prefixed!)
    ├── test_data/
    └── test_trading/
    ```

## 4. Documentation
- **Docstrings:** Required for all public modules, classes, and functions. Use Google style or NumPy style.
- **Comments:** Explain "why", not "what". Avoid obvious comments.
- **README:** Every major directory (phase) should have a brief README explaining its purpose.

## 5. Error Handling & Logging
- **Exceptions:** Use custom exception classes for domain-specific errors.
- **Logging:** Use the standard `logging` library. Structured logging is preferred.
- **No Silent Failures:** Never use bare `try-except` blocks. Log or re-raise errors.

## 6. Technology Stack
- **Language:** Python 3.10+
- **Containerization:** Docker & Docker Compose
- **Database:** TimescaleDB (PostgreSQL extension)
- **Caching/Messaging:** Redis
- **Architecture:** MCP (Model Context Protocol) for agents.

## 7. Database Connection Management
- **Connection Pooling:** ALWAYS use centralized connection pooling via `BaseMCPServer.db_engine`.
- **Implementation:**
  - MCP Servers: Pass `db_url` to `BaseMCPServer.__init__()` to initialize pooled engine.
  - Tools: Accept `engine` parameter (SQLAlchemy Engine instance), NOT `db_url` string.
  - Never create engines with `create_engine()` inside tools or methods.
  - Never call `engine.dispose()` in tools (managed by BaseMCPServer).
- **Pool Configuration:**
  ```python
  pool_size=5          # Base connections
  max_overflow=10      # Additional connections under load
  pool_pre_ping=True   # Verify before use
  pool_recycle=3600    # Recycle after 1 hour
  ```

## 8. Workflow
- **Phased Implementation:** Follow the roadmap phases strictly.
- **Validation:** Verify each step before moving to the next.

## 9. Python Best Practices (Lessons Learned from Phase 3)

### Datetime (CRITICAL)
- **NEVER use `datetime.utcnow()`** - Deprecated in Python 3.12+
- **ALWAYS use `datetime.now(timezone.utc)`** for UTC timestamps
- All datetime objects MUST be timezone-aware
- Import: `from datetime import datetime, timezone`

### Implementation Completeness (CRITICAL)
- **NEVER leave placeholder/stub implementations in production code**
- **NO functions that return hardcoded values** (e.g., `return 0.0` always)
- **NO TODO comments for critical functionality**
- If stubbing temporarily:
  - Document clearly what's stubbed and WHY
  - Create explicit ticket/issue for completion
  - Mark with `# TEMPORARY STUB - Issue #XXX` not just `# TODO`
  
### Error Handling and Scope
- NEVER reuse loop variables outside their scope
- Recalculate time-dependent values fresh when needed
- Fail-safe defaults: Conservative values on errors (e.g., correlation=0.5, not 0.0)
- Example: Calculate `pending_age` fresh for each item when logging

### Redis and Dependencies
- Classes using `self.redis` MUST receive `redis_client: redis.Redis` in [__init__](cci:1://file:///C:/projects/nexus-trading/src/agents/risk_manager.py:50:4-93:9)
- Redis returns bytes - always decode or use `json.loads()`
- Import ALL modules used (json, redis, etc.)
- Complete type hints: `redis.Redis`, not just [redis](cci:1://file:///C:/projects/nexus-trading/tests/test_agents/test_messaging.py:28:0-31:37)

### Constants and Configuration
- NO duplicate hardcoded values across files
- Use centralized modules (e.g., [src/core/risk_limits.py](cci:7://file:///C:/projects/nexus-trading/src/core/risk_limits.py:0:0-0:0))
- Import from single source of truth

### Async Best Practices
- Handle `asyncio.CancelledError` separately
- Exponential backoff: `min(2 ** retry_count, max_seconds)`
- Yield to event loop: `await asyncio.sleep(small_value)`